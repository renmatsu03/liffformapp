<script>
    $(document).ready(function () {
        const liffId = "2006792721-3gajN1ll"; // LIFF ID

        const lectures = [
            "第1回：2/16（日） 9:00～10:00<br>~割合と比　食塩水~",
            "第2回：2/23（日） 9:00～10:00<br>~割合と比　売買損益~",
            "第3回：3/2（日） 9:00～10:00<br>~割合と比　倍数算~",
            "第4回：3/9（日） 9:00～10:00<br>~速さ　旅人算~",
            "第5回：3/16（日） 9:00～10:00<br>~速さ　速さと比~"
        ];

        lectures.forEach((lecture, index) => {
            const isDisabled = (index <= 3) ? "disabled" : "";
            const labelStyle = (index <= 3) ? "style='text-decoration: line-through; color: gray;'" : "";

            $("#lecture-options").append(
                `<div class="form-check">
                    <input class="form-check-input lecture-checkbox" type="checkbox" value="${lecture}" id="lecture-${index}" ${isDisabled}>
                    <label class="form-check-label" for="lecture-${index}" ${labelStyle}>${lecture}</label>
                </div>`
            );
        });

        $("#koma-select").change(function () {
            const selectedValue = $(this).val();
            const maxSelection = selectedValue === "free" ? 1 : parseInt(selectedValue);

            $(".lecture-checkbox").prop("checked", false).prop("disabled", false);
            $("#lecture-0, #lecture-1, #lecture-2, #lecture-3").prop("disabled", true).prop("checked", false);

            if (selectedValue === "20") {
                $(".lecture-checkbox").prop("checked", true).prop("disabled", true);
            } else {
                $(".lecture-checkbox").not("#lecture-0, #lecture-1, #lecture-2, #lecture-3").prop("disabled", false);
            }

            $(".lecture-checkbox").not("#lecture-0, #lecture-1, #lecture-2, #lecture-3").off("change").on("change", function () {
                if ($(".lecture-checkbox:checked").length >= maxSelection) {
                    $(".lecture-checkbox:not(:checked)").not("#lecture-0, #lecture-1, #lecture-2, #lecture-3").prop("disabled", true);
                } else {
                    $(".lecture-checkbox").not("#lecture-0, #lecture-1, #lecture-2, #lecture-3").prop("disabled", false);
                }
                updateSubmitButtonState();
            });

            updateSubmitButtonState();
        });

        const updateSubmitButtonState = () => {
            const selectedKoma = $("#koma-select").val();
            const checkedCount = $(".lecture-checkbox:checked").length;
            const maxSelection = selectedKoma === "free" ? 1 : parseInt(selectedKoma);
            $("input[type='submit']").prop("disabled", checkedCount !== maxSelection);
        };

        // LIFF 初期化
        liff.init({ liffId: liffId })
            .then(() => {
                if (liff.isLoggedIn()) {
                    liff.getProfile().then(profile => {
                        $('input[name="line-name"]').val(profile.displayName);
                    });
                } else {
                    liff.login();
                }
            });

        // フォーム送信処理
        $("form").submit(function (event) {
            event.preventDefault();  // ページリロード防止

            const name = `${$('input[name="last-name"]').val()} ${$('input[name="first-name"]').val()}`;
            const nameKana = `${$('input[name="last-name-kana"]').val()} ${$('input[name="first-name-kana"]').val()}`;
            const grade = $('select[name="grade"]').val();
            const selectedKoma = $('#koma-select').val();
            const komaMessage = selectedKoma === "free" ? "購入コマ数: 無料1コマ" : `購入コマ数: ${selectedKoma}コマ`;

            const selectedLectures = $(".lecture-checkbox:checked").map(function () {
                return $(this).val();
            }).get();

            const msg = `#中学受験ニガテ克服講座-申込フォーム\n`
                + `LINE名: ${$('input[name="line-name"]').val()}\n`
                + `生徒様のお名前: ${name}\n`
                + `ふりがな: ${nameKana}\n`
                + `学年: ${grade}\n`
                + `${komaMessage}\n`
                + `選択した講座:\n${selectedLectures.join("\n")}`;

            liff.sendMessages([{ type: 'text', text: msg }])
                .then(() => {
                    alert("メッセージが送信されました");
                    liff.closeWindow();
                })
                .catch((error) => {
                    console.error("送信エラー", error);
                    alert("メッセージ送信に失敗しました");
                });

            return false;  // ページリロード防止
        });

    });
</script>
