<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>講座予約フォーム</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
    <form class="w-75 mx-auto">
        <p class="mt-3">名前</p>
        <div>
            <input class="form-control w-100 mt-1" name="name" placeholder="名前を入力してください" required>
        </div>

        <p class="mt-3">学年</p>
        <div>
            <select class="form-control w-100 mt-1" name="grade" required>
                <option value="">選択してください</option>
                <option value="小学1年">小学1年</option>
                <option value="小学2年">小学2年</option>
                <option value="小学3年">小学3年</option>
                <option value="小学4年">小学4年</option>
                <option value="小学5年">小学5年</option>
                <option value="小学6年">小学6年</option>
                <option value="中学1年">中学1年</option>
                <option value="中学2年">中学2年</option>
                <option value="中学3年">中学3年</option>
                <option value="高校1年">高校1年</option>
                <option value="高校2年">高校2年</option>
                <option value="高校3年">高校3年</option>
            </select>
        </div>

        <p class="mt-3">講座の購入コマ数</p>
        <div>
            <select class="form-control w-100 mt-1" name="koma" id="koma-select" required>
                <option value="">選択してください</option>
                <option value="1">1コマ</option>
                <option value="3">3コマ</option>
                <option value="5">5コマ</option>
                <option value="10">10コマ</option>
                <option value="18">18コマ</option>
            </select>
        </div>

        <p class="mt-3">参加する講座</p>
        <div id="lecture-options" class="mt-1">
            <!-- 講座選択肢が動的に追加されます -->
        </div>

        <input type="submit" class="mt-4 btn btn-primary" value="送信">
    </form>

    <script>
        const lectures = [
            "第1回：1/19 (金) 9:00～10:00<br>割合と比「食塩水」",
            "第2回：1/26 (金) 9:00～10:00<br>割合と比「売買損益」",
            "第3回：2/2 (金) 9:00～10:00<br>割合と比「倍数算」",
            "第4回：2/9 (金) 9:00～10:00<br>速さ「旅人算」",
            "第5回：2/16 (金) 9:00～10:00<br>速さ「速さと比」",
            "第6回：2/23 (金) 9:00～10:00<br>速さ「ダイヤグラム」",
            "第7回：3/2 (金) 9:00～10:00<br>和差算",
            "第8回：3/9 (金) 9:00～10:00<br>つるかめ算",
            "第9回：3/16 (金) 9:00～10:00<br>仕事算",
            "第10回：3/23 (金) 9:00～10:00<br>平面図形「面積の比・辺の比」",
            "第11回：3/30 (金) 9:00～10:00<br>平面図形「多角形」",
            "第12回：4/6 (金) 9:00～10:00<br>平面図形「図形の移動」",
            "第13回：4/13 (金) 9:00～10:00<br>数と性質「規則性」",
            "第14回：4/20 (金) 9:00～10:00<br>数と性質「約数・倍数」",
            "第15回：4/27 (金) 9:00～10:00<br>数と性質「分数や小数の計算」",
            "第16回：5/4 (金) 9:00～10:00<br>立体図形「体積・表面積」",
            "第17回：5/11 (金) 9:00～10:00<br>立体図形「切断」",
            "第18回：5/18 (金) 9:00～10:00<br>立体図形「回転体」"
        ];

        $(document).ready(function () {
            const liffId = "2006792721-3gajN1ll"; // LIFF ID を設定

            initializeLiff(liffId);

            function initializeLiff(liffId) {
                liff.init({ liffId: liffId }).then(() => {
                    console.log("LIFF 初期化完了");
                }).catch(err => {
                    console.error("LIFF 初期化失敗: ", err);
                });
            }

            $("#koma-select").change(function () {
                const selectedKoma = parseInt($(this).val());
                const lectureContainer = $("#lecture-options");
                lectureContainer.empty();

                if (selectedKoma > 0) {
                    lectures.forEach((lecture, index) => {
                        const checkbox = `
                            <div class="form-check">
                                <input class="form-check-input lecture-checkbox" type="checkbox" value="${lecture.replace(/<br>/g, '\n')}" id="lecture${index}">
                                <label class="form-check-label" for="lecture${index}">
                                    ${lecture}
                                </label>
                            </div>`;
                        lectureContainer.append(checkbox);
                    });

                    $(".lecture-checkbox").change(function () {
                        if ($(".lecture-checkbox:checked").length > selectedKoma) {
                            $(this).prop("checked", false);
                            alert(`最大で${selectedKoma}つまで選択可能です`);
                        }
                    });
                }
            });

            $("form").submit(function () {
                const name = $('input[name="name"]').val();
                const grade = $('select[name="grade"]').val();
                const selectedKoma = $('#koma-select').val();
                const selectedLectures = $(".lecture-checkbox:checked").map(function () {
                    return $(this).val();
                }).get();

                const msg = `名前: ${name}\n学年: ${grade}\n購入コマ数: ${selectedKoma}コマ\n選択した講座:\n${selectedLectures.join("\n")}`;

                if (liff.isInClient()) {
                    liff.sendMessages([{ type: 'text', text: msg }]).then(() => {
                        alert("メッセージが送信されました");
                        liff.closeWindow();
                    }).catch(error => {
                        console.error("メッセージ送信失敗: ", error);
                    });
                } else {
                    alert("LINE アプリ内で実行してください");
                }
                return false;
            });
        });
    </script>
</body>
</html>
